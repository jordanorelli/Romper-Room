{% extends 'base.html' %}
{% load foursquare_tags %}
{% load facebook_tags %}
{% load raw %}

{% block js %}
{{ block.super }}
<script src="{{ STATIC_URL }}js/mustache.js"></script>
{% if user.is_authenticated %}

{% raw %}
<script id="group-template" type="text/plain">
  <div class="venue-group">
    <div class="name">{{group.name}}</div>
    {{#group.items}}
    <div class="venue">
      <span class="venue-name">{{venue.name}}</span>
    </div>
    {{/group.items}}
  </div>
</script>
{% endraw %}

<script>
  $(document).ready(function() {
  {% if foursquare_oauth_token %}
    var groupTemplate = $('#group-template').html();

    var render = function(target, template, context) {
      $(target).append(Mustache.to_html(template, context));
    };

    var renderExploreResponse = function(response) {
      $('#foursquare-signup').remove();
      $.each(response.groups, function(i, group) {
        render('#venue-container', groupTemplate, {group: group})
      });
    };

    var explore = function(latitude, longitude) {
      var ll = latitude + ',' + longitude;
      var cachedResponse = sessionStorage.getItem(ll);

      if(cachedResponse !== null) {
        var response = JSON.parse(cachedResponse);
        console.log("rendering explore results from cache.");
        renderExploreResponse(response);
        return;
      };

      console.log("no cached explore response found.");

      $.ajax({
        type: "GET",
        url: "https://api.foursquare.com/v2/venues/explore",
        async: true,
        cache: false,
        timeout: 5000,
        data: {
          oauth_token: "{{ foursquare_oauth_token }}",
          ll: ll
        },
        success: function(data) {
          renderExploreResponse(data.response);
          sessionStorage.setItem(ll, JSON.stringify(data.response));
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          $.each([XMLHttpRequest, textStatus, errorThrown], function(i, v) {
            console.log(v);
          });
        }
      });
    };

    navigator.geolocation.getCurrentPosition(function(pos) {
      var latitude  = pos.coords.latitude;
      var longitude = pos.coords.longitude;
      explore(latitude, longitude);
    });

  {% else %}
    console.log("Didn't receive an oauth token.");
  {% endif %}
  });
</script>
{% endif %}
{% endblock %}

{% block body %}
<div class="container_12">
  <div id="venue-container" class="grid_6">
    <div id="foursquare-signup" class="signup-container">
      {% if user.foursquareuser %}
        fetching recommendations...
      {% else %}
        <a href="{% foursquare_auth_uri %}">foursquare</a>
      {% endif %}
    </div>
  </div>
  <div class="grid_6" id="facebook">
    <div id="facebook-signup" class="signup-container">
      {% if user.facebookuser %}
        we got your fb deets
      {% else %}
        <a href="{% facebook_auth_uri %}">facebook</a>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
